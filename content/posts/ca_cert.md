+++
title =  '非对称加密和自签名'
date = 2024-02-09T16:14:06+08:00
draft = false
tags= ["加密","self-signed","CA"]
categories=["系统相关"]
+++

## 简介
非对称加密不是一个单点问题，是一个体系。它在当前的应用是方方面面的，网上资料虽然多，不论是youtube视频或者博客，但是能真正说清楚的太少了。要么就是只有理论，跟实际情况脱节，要么只有命令，讲不清楚背后发生了什么。这种问题，如果缺乏一个好的知识体系，即使gpt+google玩出花来也是解决不了的。而非对称加密相关的问题多不多呢？真的很多，只是平时不显露出来。按照本博客传统，demo优先，本文会从三个案例出发，升入浅出的描述证书的原理和应用。  
- 自签名证书: 自建CA, 自签名下级证书(sub-cert)完成service,client证书的生成。通过本案例可以打通理论和openssl在实际应用中的壁垒。对于内部服务自签名证书也是十分有用，我会用etcd的配置为例。  
- nginx配置域名证书: 区别在于，第三方CA的流程，和实际生产中nginx的配置。  
- AnyConnect 扣证书: VPN也是可以配置证书的，企业中会通过配置证书来防止非企业电脑链接。而我们可以把证书扣出来，通过这种方式实现多电脑连vpn（这个操作十分tricky, 本人并不推荐大家模仿）。说这个案例是会因为，可以更好的理解根证书在操作系统中的应用。  

## 理论
理论就是大家大学在密码学课程上都会学的那一套。以课本中的B/S架构网站tls/ssl模式为例，简单总结就是: 
对象：  

- 客户端： 拥有证书，证书中包含公钥和证书信息  
- 服务端： 由于私钥  
- CA: 发行证书  

客户端访问服务器: 客户端在访问服务端的时候，首先拿到服务端给的证书。怎么确定证书是对的呢？跟自己机器上默认的根证书做校验，校验通过就是正确的证书，浏览器上就会出现一把绿色的小锁。  

服务端工作：首先，服务端需要生成一个私钥和一个证书请求，将这两个东西上传到CA机构，让CA的根证书生成sub-cert。服务端将sub-cert和私钥存储在服务器上，当用户访问过来的时候，先把sub-cert传给对方。等对方用其中的公钥对传输信息进行加密之后，用自己的私钥解密，建立tls/ssl握手链接。  

CA的工作：上面也包含了，一个是要保证出厂的硬件系统都有自家的根证书。另一个是要服务端生成sub-cert。当然，最重要的是保护好自己根证书的private key。  

如果你对上面的过程还不是特别清楚，推荐我同事的[这篇文章](https://www.kawabangga.com/posts/5330), 只需要看上半部分，下半部分证书签发过程不是本文的重点。  


## 